<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Generate Audio</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <style>
      .playground-container {
        max-width: 600px;
        margin: 2rem auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
        padding: 2rem;
      }
      .playground-container h1 {
        margin-top: 0;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 0.5rem;
      }
      select,
      textarea,
      input[type="number"],
      input[type="file"] {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .instructions {
        background: #f1f1f1;
        border-left: 4px solid #2c3e50;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 4px;
        font-size: 0.95rem;
      }
      button {
        background: #2c3e50;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      button:hover {
        background: #1a242f;
      }
      .audio-result {
        margin-top: 2rem;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="playground-container">
      <h1>ğŸ™ï¸ OpenAI Speech Playground</h1>
      
      <nav style="margin-bottom: 1rem;">
        <a href="{{ url_for('index') }}" style="color: #2c3e50; text-decoration: none;">â† Back to Home</a>
      </nav>
      
      <!-- Usage Information -->
      {% if usage_info %}
      <div class="instructions" style="background: #f8f9fa; border-left: 4px solid #6c757d;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0;">ğŸ’³ Usage Information</h3>
          <button type="button" onclick="refreshUsage()" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">ğŸ”„ Refresh</button>
        </div>
        <div id="usage-details">
          {% if usage_info.success %}
            <p><strong>Current Usage:</strong> {{ usage_info.usage }}</p>
            <p><strong>Remaining Credits:</strong> {{ usage_info.remaining }}</p>
          {% else %}
            <p><strong>ğŸ’¡ Tip:</strong> {{ usage_info.message }}</p>
            {% if usage_info.note %}
            <p>ğŸ“Š {{ usage_info.note }}</p>
            {% endif %}
            {% if usage_info.tip %}
            <p>ğŸ’° {{ usage_info.tip }}</p>
            {% endif %}
          {% endif %}
        </div>
      </div>
      {% endif %}
      
      <div class="instructions">
        <strong>Instructions:</strong>
        <ul>
          <li>Paste or type your text below <b>or</b> upload a text file.</li>
          <li>Select a model and voice.</li>
          <li>Adjust the speed (1.0 is normal speed).</li>
          <li>Optionally, provide custom instructions for the model.</li>
          <li>
            Click "Generate Audio" to synthesize speech using OpenAI's TTS API.
          </li>
          <li>
            If you upload a file, you will get a zip of audio chunks. If you
            paste text, you will get inline audio playback.
          </li>
        </ul>
      </div>
      <div
        class="instructions"
        style="background: #eaf6ff; border-left: 4px solid #0074d9"
      >
        <strong>Pricing (as of June 2024):</strong>
        <ul style="margin-bottom: 0">
          <li><b>tts-1</b>: $0.015 / 1K characters</li>
          <li><b>tts-1-hd</b>: $0.030 / 1K characters</li>
          <li><b>gpt-4o-mini-tts</b>: $0.015 / 1K characters</li>
        </ul>
        <span style="font-size: 0.95em; color: #555"
          >See
          <a href="https://platform.openai.com/docs/models#tts" target="_blank"
            >OpenAI Model Pricing</a
          >
          for details.</span
        >
      </div>
      <form id="audio-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="model">Model</label>
          <select name="model" id="model" required>
            <option value="gpt-4o-mini-tts">gpt-4o-mini-tts</option>
            <option value="tts-1">tts-1</option>
            <option value="tts-1-hd">tts-1-hd</option>
          </select>
        </div>
        <div class="form-group">
          <label for="voice">Voice</label>
          <select name="voice" id="voice" required>
            <option value="alloy">Alloy</option>
            <option value="ash">Ash</option>
            <option value="ballad">Ballad</option>
            <option value="coral">Coral</option>
            <option value="echo">Echo</option>
            <option value="fable">Fable</option>
            <option value="nova">Nova</option>
            <option value="onyx">Onyx</option>
            <option value="sage">Sage</option>
            <option value="shimmer">Shimmer</option>
          </select>
        </div>
        <div class="form-group">
          <label for="speed">Speed (0.25 - 4.0)</label>
          <input
            type="number"
            step="0.25"
            min="0.25"
            max="4.0"
            name="speed"
            id="speed"
            value="1.0"
            required
          />
        </div>
        <div class="form-group">
          <label for="instructions">Instructions</label>
          <textarea name="instructions" id="instructions" required>
Speak like you are reading a book for me. I am using markdown text, so take care of proper stops when going to next line, paragraph or headings. Don't call out the special characters used to indicate the format of the text.</textarea
          >
        </div>
        <div class="form-group">
          <label for="input_text">Text</label>
          <textarea
            name="input_text"
            id="input_text"
            placeholder="Paste your text here..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="text_file">Or upload a text file</label>
          <input type="file" name="text_file" id="text_file" accept=".txt" />
        </div>
        <button type="submit">Generate Audio</button>
        <div id="progress-container" style="display: none">
          <h3>ğŸ”„ Generation Progress</h3>
          <div style="background: #f8f9fa; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
            <p id="progress-text">Progress: 0%</p>
            <progress id="progress-bar" value="0" max="100" style="width: 100%; height: 20px;"></progress>
          </div>
          
          <!-- Individual Chunks Section -->
          <div id="chunks-container" style="display: none; margin-top: 1rem;">
            <h4>ğŸ“„ Generated Chunks</h4>
            <div id="chunks-list" style="background: #f8f9fa; border-radius: 4px; padding: 1rem; max-height: 300px; overflow-y: auto;">
              <!-- Individual chunks will be added here dynamically -->
            </div>
          </div>
        </div>
      </form>
      
      <div class="audio-result" id="audio-result" style="display: none">
        <h3>ğŸµ Generated Audio</h3>
        
        <!-- Audio Player Section -->
        <div id="audio-player-section" style="display: none; margin-bottom: 1rem;">
          <h4>ğŸµ Play Audio</h4>
          <audio id="audio-player" controls style="width: 100%; margin-bottom: 1rem;">
            Your browser does not support the audio element.
          </audio>
        </div>
        
        <!-- Download Section -->
        <div class="download-buttons" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a id="download-link" href="#" download="openai_audio.mp3" style="display: none; background: #28a745; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 4px;">
            ğŸ“¥ Download Audio
          </a>
          <button id="play-button" onclick="loadAudioPlayer()" style="display: none; background: #007bff;">
            ğŸµ Load Audio Player
          </button>
        </div>
        
        <!-- Individual Chunks Notice for File Uploads -->
        <div id="chunks-notice" style="display: none; margin-top: 1rem; padding: 1rem; background: #e8f4fd; border-radius: 4px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 0.5rem 0;">ğŸ“„ Individual Audio Chunks</h4>
          <p style="margin: 0; font-size: 0.9rem;">Your file was split into multiple chunks. Each chunk can be played individually below:</p>
        </div>
      </div>
      </div>
    </div>
    <script>
      const form = document.getElementById("audio-form");
      const audioResult = document.getElementById("audio-result");
      const audioPlayer = document.getElementById("audio-player");
      const audioPlayerSection = document.getElementById("audio-player-section");
      const downloadLink = document.getElementById("download-link");
      const playButton = document.getElementById("play-button");
      const progressContainer = document.getElementById("progress-container");
      const progressText = document.getElementById("progress-text");
      const progressBar = document.getElementById("progress-bar");
      const chunksContainer = document.getElementById("chunks-container");
      const chunksList = document.getElementById("chunks-list");
      const chunksNotice = document.getElementById("chunks-notice");

      let currentFileType = null;
      let progressId = null;

      // Refresh usage information
      function refreshUsage() {
        fetch('/generate-audio-usage')
          .then(response => response.json())
          .then(data => {
            const usageDetails = document.getElementById('usage-details');
            if (usageDetails) {
              if (data.success) {
                usageDetails.innerHTML = `
                  <p><strong>Current Usage:</strong> ${data.usage}</p>
                  <p><strong>Remaining Credits:</strong> ${data.remaining}</p>
                `;
              } else {
                usageDetails.innerHTML = `
                  <p><strong>ğŸ’¡ Tip:</strong> ${data.message}</p>
                  ${data.note ? `<p>ğŸ“Š ${data.note}</p>` : ''}
                  ${data.tip ? `<p>ğŸ’° ${data.tip}</p>` : ''}
                `;
              }
            }
          })
          .catch(error => {
            console.error('Error refreshing usage:', error);
          });
      }

      // Load audio player for inline playback
      function loadAudioPlayer() {
        fetch(`/generate-audio-play/${progressId}`)
          .then(response => response.blob())
          .then(blob => {
            const audioUrl = URL.createObjectURL(blob);
            audioPlayer.src = audioUrl;
            audioPlayerSection.style.display = '';
            playButton.style.display = 'none';
          })
          .catch(error => {
            console.error('Error loading audio player:', error);
            alert('Failed to load audio player');
          });
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        
        // Reset UI
        audioResult.style.display = "none";
        audioPlayerSection.style.display = "none";
        playButton.style.display = "none";
        downloadLink.style.display = "none";
        progressContainer.style.display = "";
        chunksContainer.style.display = "none";
        chunksNotice.style.display = "none";
        chunksList.innerHTML = '';
        progressBar.style.display = "";
        progressBar.value = 0;
        progressText.textContent = "Initializing...";
        
        const formData = new FormData(form);
        fetch("/generate-audio", {
          method: "POST",
          body: formData,
        }).then(async (resp) => {
          const data = await resp.json();
          if (!resp.ok) {
            alert(data.error || "Failed to generate audio.");
            progressContainer.style.display = "none";
            return;
          }
          progressId = data.progress_id;
          currentFileType = data.file_type;
          pollAudioProgress();
        }).catch(error => {
          console.error('Error starting generation:', error);
          alert('Failed to start audio generation');
          progressContainer.style.display = "none";
        });
      });

      function pollAudioProgress() {
        fetch(`/generate-audio-progress/${progressId}`)
          .then((resp) => resp.json())
          .then((data) => {
            if (data.status === "done") {
              progressBar.value = 100;
              progressText.textContent = "Generation complete!";
              
              // Update chunks display if available
              if (data.chunks && data.chunks.length > 0) {
                updateChunksDisplay(data.chunks);
                chunksContainer.style.display = "";
              }
              
              // Hide just the progress bar section, not the entire container
              progressBar.style.display = "none";
              progressText.textContent = "";
              
              showAudioResult();
            } else if (data.status === "processing") {
              let percent = Math.floor((data.current / data.total) * 100);
              progressBar.value = percent;
              progressText.textContent = `Progress: ${percent}% (${data.current}/${data.total} chunks)`;
              
              // Update chunks display if available
              if (data.chunks && data.chunks.length > 0) {
                updateChunksDisplay(data.chunks);
                chunksContainer.style.display = "";
              }
              
              setTimeout(pollAudioProgress, 1000);
            } else if (data.status === "error") {
              progressText.textContent = "Error: " + (data.error || "Unknown error");
              progressContainer.style.display = "none";
            } else {
              // Still processing, continue polling
              setTimeout(pollAudioProgress, 1000);
            }
          })
          .catch(error => {
            console.error('Error polling progress:', error);
            progressText.textContent = "Error checking progress";
            progressContainer.style.display = "none";
          });
      }

      function updateChunksDisplay(chunks) {
        chunksList.innerHTML = '';
        
        if (chunks.length > 0) {
          chunksNotice.style.display = "";
        }
        
        chunks.forEach((chunk, index) => {
          const chunkDiv = document.createElement('div');
          chunkDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem; background: white;';
          
          chunkDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
              <strong>Chunk ${chunk.index}</strong>
              <div style="display: flex; gap: 0.5rem;">
                <audio controls style="height: 32px; min-width: 200px;">
                  <source src="/generate-audio-chunk/${progressId}/${chunk.index}" type="audio/mpeg">
                  Your browser does not support the audio element.
                </audio>
                <a href="/generate-audio-chunk-download/${progressId}/${chunk.index}" 
                   download="openai_chunk_${chunk.index}.mp3"
                   style="background: #28a745; color: white; padding: 0.25rem 0.75rem; text-decoration: none; border-radius: 4px; font-size: 0.9rem;">
                  ğŸ“¥ Download
                </a>
              </div>
            </div>
          `;
          
          chunksList.appendChild(chunkDiv);
        });
      }

      function showAudioResult() {
        audioResult.style.display = "";
        
        // Set up download link
        downloadLink.href = `/generate-audio-download/${progressId}`;
        downloadLink.style.display = "";
        
        if (currentFileType === "mp3") {
          // For single MP3, show play button
          playButton.style.display = "";
          downloadLink.download = "openai_speech.mp3";
        } else if (currentFileType === "zip") {
          // For ZIP files, just show download
          downloadLink.download = "openai_audio_chunks.zip";
        }
      }
    </script>
  </body>
</html>
